<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .timetable-container {
            margin-top: 20px;
        }
        .period-cell {
            min-width: 150px;
            height: 100px;
            vertical-align: middle;
        }
        .period-cell:hover {
            background-color: #f8f9fa;
        }
        .admin-controls {
            margin-bottom: 20px;
        }
        .period-content {
            padding: 5px;
        }
        .subject {
            font-weight: bold;
            display: block;
        }
        .teacher {
            font-size: 0.9em;
            color: #666;
            display: block;
        }
        .time {
            font-size: 0.8em;
            color: #888;
            display: block;
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Class Timetable</h4>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="classSelect">Class</label>
                                    <select class="form-control" id="classSelect" required>
                                        <option value="">Select Class</option>
                                        <% for(let i = 1; i <= 12; i++) { %>
                                            <option value="<%= i %>">Class <%= i %></option>
                                        <% } %>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="sectionSelect">Section</label>
                                    <select class="form-control" id="sectionSelect" required>
                                        <option value="">Select Section</option>
                                        <% ['A', 'B', 'C', 'D', 'E'].forEach(section => { %>
                                            <option value="<%= section %>">Section <%= section %></option>
                                        <% }); %>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Day</th>
                                        <th>Period 1</th>
                                        <th>Period 2</th>
                                        <th>Period 3</th>
                                        <th>Period 4</th>
                                        <th>Period 5</th>
                                        <th>Period 6</th>
                                        <th>Period 7</th>
                                        <th>Period 8</th>
                                    </tr>
                                </thead>
                                <tbody id="timetableBody">
                                    <% ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'].forEach(day => { %>
                                        <tr>
                                            <td class="font-weight-bold"><%= day %></td>
                                            <% for(let i = 1; i <= 8; i++) { %>
                                                <td class="period-cell" data-day="<%= day %>" data-period="<%= i %>">
                                                    <div class="period-content">
                                                        <span class="subject"></span>
                                                        <span class="teacher"></span>
                                                        <span class="time"></span>
                                                    </div>
                                                </td>
                                            <% } %>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Timetable Modal -->
    <div class="modal fade" id="addTimetableModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add/Edit Period</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="timetableForm">
                        <input type="hidden" id="periodId">
                        <div class="mb-3">
                            <label class="form-label">Subject</label>
                            <input type="text" class="form-control" id="subject" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Teacher</label>
                            <select class="form-control" id="teacherId" required>
                                <% teachers.forEach(teacher => { %>
                                <option value="<%= teacher._id %>"><%= teacher.name %></option>
                                <% }); %>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Start Time</label>
                            <input type="time" class="form-control" id="startTime" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">End Time</label>
                            <input type="time" class="form-control" id="endTime" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveTimetable">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modal = new bootstrap.Modal(document.getElementById('addTimetableModal'));
            const form = document.getElementById('timetableForm');
            const saveButton = document.getElementById('saveTimetable');

            // Add period button click
            document.querySelectorAll('.add-period').forEach(button => {
                button.addEventListener('click', function() {
                    document.getElementById('periodId').value = '';
                    form.reset();
                    modal.show();
                });
            });

            // Edit period button click
            document.querySelectorAll('.edit-period').forEach(button => {
                button.addEventListener('click', function() {
                    const periodId = this.dataset.periodId;
                    // Fetch period details and populate form
                    fetch(`/api/timetable/${periodId}`)
                        .then(response => response.json())
                        .then(period => {
                            document.getElementById('periodId').value = period._id;
                            document.getElementById('subject').value = period.subject;
                            document.getElementById('teacherId').value = period.teacherId;
                            document.getElementById('startTime').value = period.startTime;
                            document.getElementById('endTime').value = period.endTime;
                            modal.show();
                        });
                });
            });

            // Delete period button click
            document.querySelectorAll('.delete-period').forEach(button => {
                button.addEventListener('click', function() {
                    if (confirm('Are you sure you want to delete this period?')) {
                        const periodId = this.dataset.periodId;
                        fetch(`/api/timetable/${periodId}`, {
                            method: 'DELETE'
                        })
                        .then(response => {
                            if (response.ok) {
                                location.reload();
                            }
                        });
                    }
                });
            });

            // Save timetable
            saveButton.addEventListener('click', function() {
                const formData = {
                    subject: document.getElementById('subject').value,
                    teacherId: document.getElementById('teacherId').value,
                    startTime: document.getElementById('startTime').value,
                    endTime: document.getElementById('endTime').value
                };

                const periodId = document.getElementById('periodId').value;
                const url = periodId ? `/api/timetable/${periodId}` : '/api/timetable';
                const method = periodId ? 'PUT' : 'POST';

                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    if (response.ok) {
                        modal.hide();
                        location.reload();
                    }
                });
            });
        });

        // Load timetable when class and section are selected
        async function loadTimetable() {
            const classId = document.getElementById('classSelect').value;
            const section = document.getElementById('sectionSelect').value;

            if (!classId || !section) return;

            try {
                const response = await fetch(`/api/timetable/class/${classId}-${section}`);
                const timetable = await response.json();
                updateTimetableDisplay(timetable);
            } catch (error) {
                console.error('Error loading timetable:', error);
            }
        }

        // Update timetable display
        function updateTimetableDisplay(timetable) {
            const cells = document.querySelectorAll('.period-cell');
            cells.forEach(cell => {
                const day = cell.dataset.day;
                const period = parseInt(cell.dataset.period);
                const dayData = timetable.days.find(d => d.day === day);
                const periodData = dayData ? dayData.periods.find(p => p.periodNumber === period) : null;

                const subjectSpan = cell.querySelector('.subject');
                const teacherSpan = cell.querySelector('.teacher');
                const timeSpan = cell.querySelector('.time');

                if (periodData) {
                    subjectSpan.textContent = periodData.subject;
                    teacherSpan.textContent = periodData.teacher.name;
                    timeSpan.textContent = `${periodData.startTime} - ${periodData.endTime}`;
                } else {
                    subjectSpan.textContent = '';
                    teacherSpan.textContent = '';
                    timeSpan.textContent = '';
                }
            });
        }

        // Event listeners
        document.getElementById('classSelect').addEventListener('change', loadTimetable);
        document.getElementById('sectionSelect').addEventListener('change', loadTimetable);

        // If user is a student, pre-select their class and section
        <% if (user && user.role === 'student') { %>
            document.getElementById('classSelect').value = '<%= user.class %>';
            document.getElementById('sectionSelect').value = '<%= user.section %>';
            loadTimetable();
        <% } %>
    </script>
</body>
</html> 